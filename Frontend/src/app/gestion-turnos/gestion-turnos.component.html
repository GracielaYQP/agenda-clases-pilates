<div class="table-container" *ngIf="horarios.length > 0">
  <h2>Gesti√≥n de Turnos</h2>
  <table>
    <thead>
      <tr>
        <th>Horario</th>
        <th *ngFor="let dia of dias">
          <div>{{ dia.split(' ')[0] }}</div>
          <div>{{ dia.split(' ')[1] }}</div>
        </th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let hora of horas">
        <td class="hora-columna">{{ hora }}</td>
        <td *ngFor="let dia of dias">
          <!-- Bloqueo espec√≠fico para Viernes 8:00 y 19:00 -->
          <ng-container *ngIf="!(dia === 'Viernes' && (hora === '08:00' || hora === '18:00')); else bloqueado">
            <ng-container *ngIf="hasTurno(dia, hora); else sinTurno">
              <ng-container *ngFor="let turno of getTurnos(dia, hora)">
                <div
                  class="clickeable {{ turno.nivel.toLowerCase() }}"
                  (click)="abrirTurno(turno)">
                  <div class="nivel">{{ turno.nivel }}</div>
                  <div class="camas">Camas libres: {{ turno.camasDisponibles }}</div>
                  <div class="reservas" *ngIf="turno.reservas && turno.reservas.length > 0">
                    <div *ngFor="let r of turno.reservas">
                      <!-- Mostrar nombre y apellido si sos admin o si el turno coincide con tu nivel -->
                      <ng-container *ngIf="rolUsuario === 'admin' || turno.nivel.toLowerCase() === usuarioNivel.toLowerCase()">
                        {{ r.nombre }} {{ r.apellido }}
                      </ng-container>
                    </div>
                  </div>
                </div>
              </ng-container>
            </ng-container>
          </ng-container>

          <ng-template #sinTurno>
            <div class="no-disponible"> -- </div>
          </ng-template>

          <ng-template #bloqueado>
            <div class="no-disponible">No disponible</div>
          </ng-template>
        </td>
      </tr>
    </tbody>
  </table>
</div>
<!-- ‚úÖ MODAL PARA ADMIN -->
<div *ngIf="modalAbierto" class="modal-overlay">
  <div class="modal-content">
    <h3>Editar Turno: {{ turnoSeleccionado.dia }} - {{ turnoSeleccionado.hora }}</h3>
    <p>Nivel: {{ turnoSeleccionado.nivel }}</p>

    <div *ngIf="turnoSeleccionado.reservas?.length > 0">
      <h4>Reservas actuales:</h4>

      <ul>
        <ng-container *ngFor="let r of turnoSeleccionado.reservas">
          <li>
            {{ r.nombre }} {{ r.apellido }}
            <button class="btn-anular" (click)="abrirModalTipoCancelacion(r)">Anular</button>
          </li>
        </ng-container>
      </ul>

    </div>

    <div *ngIf="turnoSeleccionado.reservas?.length === 0">
      <p>No hay reservas a√∫n en este turno.</p>
    </div>

    <!-- üîΩ FORMULARIO PARA AGREGAR NUEVA RESERVA -->
    <hr>
    <button (click)="mostrarFormAgregar = !mostrarFormAgregar"
      [ngClass]="mostrarFormAgregar ? 'btn-cancelar-toggle' : 'btn-agregar-toggle'">
      {{ mostrarFormAgregar ? 'Cancelar' : '+ Agregar reserva para otro usuario' }}
    </button>

    <div *ngIf="mostrarFormAgregar" class="form-agregar">
      <label for="modoBusqueda">Buscar usuario por:</label>
      <select id="modoBusqueda" [(ngModel)]="busquedaModo">
        <option value="nombre-apellido">Nombre y Apellido</option>
        <option value="telefono">Tel√©fono</option>
      </select>

      <!-- Campos din√°micos -->
      <div *ngIf="busquedaModo === 'nombre-apellido'">
        <input type="text" [(ngModel)]="nombreNuevo" placeholder="Nombre" />
        <input type="text" [(ngModel)]="apellidoNuevo" placeholder="Apellido" />
      </div>

      <div *ngIf="busquedaModo === 'telefono'">
        <input type="text" [(ngModel)]="telefonoNuevo" placeholder="Tel√©fono" />
      </div>
      <!-- Checklist para indicar si es una recuperaci√≥n -->
      <div class="form-group">
        <label for="tipoReserva"><strong>Tipo de reserva:</strong></label>
        <select id="tipoReserva" [(ngModel)]="reservaAutomatica">
          <option [ngValue]="true">Clase habitual (recurrente)</option>
          <option [ngValue]="false">Recuperaci√≥n</option>
        </select>
      </div>

      <button (click)="agregarReserva()" class="btn-confirmar">Confirmar</button>
    </div>
    <!-- ‚úÖ Mensaje de confirmaci√≥n para admin -->
    <div *ngIf="mostrarConfirmacionAdmin"
        [ngClass]="{'mensaje-confirmacion': true, 'success': !esErrorAdmin, 'error': esErrorAdmin}">
      {{ mensajeAdminReserva }}
    </div>
    <!-- Bot√≥n para cerrar -->
    <button class="btn-cerrar" (click)="cerrarModal()" class="btn-cerrar">Cerrar</button>
  </div>
</div>
<!-- ‚úÖ MODAL  PARA ALUMNO -->
<div *ngIf="modalAlumnoAbierto" class="modal-overlay">
  <div class="modal-content">
    <h3>Confirmar Reserva</h3>
    <p><strong>Nombre:</strong> {{ nombreUsuario }}</p>
    <p><strong>Apellido:</strong> {{ apellidoUsuario }}</p>
    <p><strong>D√≠a:</strong> {{ turnoSeleccionado?.dia }}</p>
    <p><strong>Hora:</strong> {{ turnoSeleccionado?.hora }}</p>
    <p><strong>Nivel:</strong> {{ turnoSeleccionado?.nivel }}</p>
    <!-- Checklist para indicar si es una recuperaci√≥n -->
    <div class="form-group">
      <label for="tipoReserva"><strong>Tipo de reserva:</strong></label>
      <select id="tipoReserva" [(ngModel)]="reservaAutomatica">
        <option [ngValue]="true">Clase habitual (recurrente)</option>
        <option [ngValue]="false">Recuperaci√≥n</option>
      </select>
    </div>


    <button class="btn-confirmar" (click)="confirmarReserva()">‚úÖ Confirmar</button>
    <button class="btn-cerrar" (click)="cerrarModalAlumno()">Cancelar</button>

    <div *ngIf="mostrarConfirmacion"
        [ngClass]="{'mensaje-confirmacion': true, 'success': !esErrorReserva, 'error': esErrorReserva}">
      {{ mensajeReserva }}
    </div>
  
  </div>
</div>
<!-- üîΩ MODAL CONFIRMAR TIPO DE CANCELACI√ìN -->
<div *ngIf="mostrarModalTipoCancelacion" class="modal-confirmacion">
  <p>¬øQuer√©s cancelar la reserva de <b>{{ reservaSeleccionada.nombre }} {{ reservaSeleccionada.apellido }}</b>?</p>

  <div style="text-align: center;">
    <button class="btn-cancelar" (click)="confirmarCancelacion('momentanea')">üïí Solo por esta vez</button>
    <button class="btn-cancelar" (click)="confirmarCancelacion('permanente')">‚ùå Cancelar permanentemente</button>
    <button class="btn-cerrar" (click)="cerrarModalTipo()">üö´ Cerrar</button>
  </div>
</div>



